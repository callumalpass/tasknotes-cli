#!/usr/bin/env node

const { Command } = require('commander');
const pkg = require('../package.json');

// Import commands
const createCommand = require('../commands/create');
const listCommand = require('../commands/list');
const completeCommand = require('../commands/complete');
const searchCommand = require('../commands/search');
const interactiveCommand = require('../commands/interactive');
const configCommand = require('../commands/config');

const program = new Command();

program
  .name('tn')
  .description('TaskNotes CLI - Create and manage tasks from the command line')
  .version(pkg.version);

// Explicit commands
program
  .command('create <text>')
  .description('Create a task from natural language text')
  .action(createCommand.handler);

program
  .command('list')
  .description('List tasks')
  .option('--today', 'Show only today\'s tasks')
  .option('--overdue', 'Show only overdue tasks')
  .option('--completed', 'Show completed tasks')
  .option('--filter <expression>', 'Advanced filter expression (e.g., "priority:high AND tags:urgent")')
  .option('--limit <number>', 'Limit number of results', '20')
  .option('--json', 'Output results as JSON')
  .action(listCommand.handler);

program
  .command('complete <taskId>')
  .description('Mark a task as complete')
  .action(completeCommand.handler);

program
  .command('search <query>')
  .description('Search tasks')
  .action(searchCommand.handler);

program
  .command('interactive')
  .alias('i')
  .description('Enter interactive mode with real-time preview')
  .action(interactiveCommand.handler);

program
  .command('config')
  .description('Configure TaskNotes CLI settings')
  .option('--set <key=value>', 'Set a configuration value')
  .option('--get <key>', 'Get a configuration value')
  .option('--list', 'List all configuration')
  .action(configCommand.handler);

program
  .command('filter-help')
  .description('Show advanced filter syntax help')
  .action(() => {
    const FilterParser = require('../lib/filter-parser');
    const parser = new FilterParser();
    console.log(parser.getHelpText());
  });

// Add default action for unrecognized arguments (task creation)
program
  .argument('[text...]', 'Task text to create (if not a recognized command)')
  .action((text) => {
    if (text && text.length > 0) {
      // Join all arguments as task text
      createCommand.handler(text.join(' '));
    } else {
      // No arguments - enter interactive mode
      interactiveCommand.handler();
    }
  });

program.parse();